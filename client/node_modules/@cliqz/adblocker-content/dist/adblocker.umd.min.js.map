{"version":3,"file":"adblocker.umd.min.js","sources":["../adblocker.ts"],"sourcesContent":["/*!\n * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at https://mozilla.org/MPL/2.0/.\n */\n\nimport type { AST } from '@cliqz/adblocker-extended-selectors';\n\nconst SCRIPT_ID = 'cliqz-adblocker-script';\nconst IGNORED_TAGS = new Set(['br', 'head', 'link', 'meta', 'script', 'style', 's']);\n\nexport type Lifecycle = 'start' | 'dom-update';\n\nexport interface IBackgroundCallback {\n  classes: string[];\n  hrefs: string[];\n  ids: string[];\n  lifecycle: Lifecycle;\n}\n\nexport interface IMessageFromBackground {\n  active: boolean;\n  scripts: string[];\n  styles: string;\n  extended: {\n    ast: AST;\n    remove: boolean;\n    attribute?: string | undefined;\n  }[];\n}\n\nfunction isElement(node: Node): node is Element {\n  // https://developer.mozilla.org/en-US/docs/Web/API/Node/nodeType#node_type_constants\n  return node.nodeType === 1; // Node.ELEMENT_NODE;\n}\n\nfunction getElementsFromMutations(mutations: MutationRecord[]): Element[] {\n  // Accumulate all nodes which were updated in `nodes`\n  const elements: Element[] = [];\n\n  for (const mutation of mutations) {\n    if (mutation.type === 'attributes') {\n      if (isElement(mutation.target)) {\n        elements.push(mutation.target);\n      }\n    } else if (mutation.type === 'childList') {\n      for (const addedNode of mutation.addedNodes) {\n        if (isElement(addedNode) && addedNode.id !== SCRIPT_ID) {\n          elements.push(addedNode);\n        }\n      }\n    }\n  }\n\n  return elements;\n}\n\n/**\n * WARNING: this function should be self-contained and not rely on any global\n * symbol. That constraint needs to be fulfilled because this function can\n * potentially be injected in content-script (e.g.: see PuppeteerBlocker for\n * more details).\n */\nexport function extractFeaturesFromDOM(roots: Element[]): {\n  classes: string[];\n  hrefs: string[];\n  ids: string[];\n} {\n  // NOTE: This cannot be global as puppeteer needs to be able to serialize this function.\n  const ignoredTags = new Set(['br', 'head', 'link', 'meta', 'script', 'style', 's']);\n  const classes: Set<string> = new Set();\n  const hrefs: Set<string> = new Set();\n  const ids: Set<string> = new Set();\n\n  for (const root of roots) {\n    for (const element of [\n      root,\n      ...root.querySelectorAll(\n        '[id]:not(html):not(body),[class]:not(html):not(body),[href]:not(html):not(body)',\n      ),\n    ]) {\n      if (ignoredTags.has(element.nodeName.toLowerCase())) {\n        continue;\n      }\n\n      // Update ids\n      const id = element.id;\n      if (id) {\n        ids.add(id);\n      }\n\n      // Update classes\n      const classList = element.classList;\n      if (classList) {\n        for (const cls of classList) {\n          classes.add(cls);\n        }\n      }\n\n      // Update href\n      const href = element.getAttribute('href');\n      if (typeof href === 'string') {\n        hrefs.add(href);\n      }\n    }\n  }\n\n  return {\n    classes: Array.from(classes),\n    hrefs: Array.from(hrefs),\n    ids: Array.from(ids),\n  };\n}\n\nexport interface FeaturesUpdate {\n  type: 'features';\n  ids: string[];\n  classes: string[];\n  hrefs: string[];\n}\n\nexport interface ElementsUpdate {\n  type: 'elements';\n  elements: Element[];\n}\n\nexport type DOMUpdate = FeaturesUpdate | ElementsUpdate;\n\nexport class DOMMonitor {\n  private knownIds: Set<string> = new Set();\n  private knownHrefs: Set<string> = new Set();\n  private knownClasses: Set<string> = new Set();\n\n  private observer: MutationObserver | null = null;\n\n  constructor(private readonly cb: (update: DOMUpdate) => void) {}\n\n  public queryAll(window: Pick<Window, 'document'>): void {\n    this.cb({ type: 'elements', elements: [window.document.documentElement] });\n    this.handleUpdatedNodes([window.document.documentElement]);\n  }\n\n  public start(\n    window: Pick<Window, 'document'> & { MutationObserver?: typeof MutationObserver },\n  ): void {\n    if (this.observer === null && window.MutationObserver !== undefined) {\n      this.observer = new window.MutationObserver((mutations: MutationRecord[]) => {\n        this.handleUpdatedNodes(getElementsFromMutations(mutations));\n      });\n\n      this.observer.observe(window.document.documentElement, {\n        // Monitor some attributes\n        attributes: true,\n        attributeFilter: ['class', 'id', 'href'],\n        childList: true,\n        subtree: true,\n      });\n    }\n  }\n\n  public stop(): void {\n    if (this.observer !== null) {\n      this.observer.disconnect();\n      this.observer = null;\n    }\n  }\n\n  public handleNewFeatures({\n    hrefs,\n    ids,\n    classes,\n  }: {\n    hrefs: string[];\n    ids: string[];\n    classes: string[];\n  }): boolean {\n    const newIds: string[] = [];\n    const newClasses: string[] = [];\n    const newHrefs: string[] = [];\n\n    // Update ids\n    for (const id of ids) {\n      if (this.knownIds.has(id) === false) {\n        newIds.push(id);\n        this.knownIds.add(id);\n      }\n    }\n\n    for (const cls of classes) {\n      if (this.knownClasses.has(cls) === false) {\n        newClasses.push(cls);\n        this.knownClasses.add(cls);\n      }\n    }\n\n    for (const href of hrefs) {\n      if (this.knownHrefs.has(href) === false) {\n        newHrefs.push(href);\n        this.knownHrefs.add(href);\n      }\n    }\n\n    if (newIds.length !== 0 || newClasses.length !== 0 || newHrefs.length !== 0) {\n      this.cb({\n        type: 'features',\n        classes: newClasses,\n        hrefs: newHrefs,\n        ids: newIds,\n      });\n      return true;\n    }\n\n    return false;\n  }\n\n  private handleUpdatedNodes(elements: Element[]): boolean {\n    if (elements.length !== 0) {\n      this.cb({\n        type: 'elements',\n        elements: elements.filter((e) => IGNORED_TAGS.has(e.nodeName.toLowerCase()) === false),\n      });\n      return this.handleNewFeatures(extractFeaturesFromDOM(elements));\n    }\n\n    return false;\n  }\n}\n\n/**\n * Wrap a self-executing script into a block of custom logic to remove the\n * script tag once execution is terminated. This can be useful to not leave\n * traces in the DOM after injections.\n */\nexport function autoRemoveScript(script: string): string {\n  // Minified using 'terser'\n  return `try{${script}}catch(c){}!function(){var c=document.currentScript,e=c&&c.parentNode;e&&e.removeChild(c)}();`;\n  // Original:\n  //\n  //    try {\n  //      ${script}\n  //    } catch (ex) { }\n  //\n  //    (function() {\n  //      var currentScript = document.currentScript;\n  //      var parent = currentScript && currentScript.parentNode;\n  //\n  //      if (parent) {\n  //        parent.removeChild(currentScript);\n  //      }\n  //    })();\n}\n\nfunction insertNode(node: Node, document: Document) {\n  const parent = document.head || document.documentElement || document;\n  if (parent !== null) {\n    parent.appendChild(node);\n  }\n}\n\nfunction injectScriptlet(s: string, doc: Document): void {\n  const script = doc.createElement('script');\n  script.type = 'text/javascript';\n  script.id = SCRIPT_ID;\n  script.async = false;\n  script.appendChild(doc.createTextNode(autoRemoveScript(s)));\n\n  insertNode(script, doc);\n}\n\nfunction isFirefox(doc: Document) {\n  try {\n    return doc.defaultView?.navigator?.userAgent?.indexOf('Firefox') !== -1;\n  } catch (e) {\n    return false;\n  }\n}\n\nasync function injectScriptletFirefox(s: string, doc: Document) {\n  const win = doc.defaultView!;\n  const script = doc.createElement('script');\n  script.async = false;\n  script.id = SCRIPT_ID;\n  const blob = new win.Blob([autoRemoveScript(s)], { type: 'text/javascript; charset=utf-8' });\n  const url = win.URL.createObjectURL(blob);\n\n  // a hack for tests to that allows for async URL.createObjectURL\n  // eslint-disable-next-line @typescript-eslint/await-thenable\n  script.src = await url;\n\n  insertNode(script, doc);\n  win.URL.revokeObjectURL(url);\n}\n\nexport function injectScript(s: string, doc: Document): void {\n  if (isFirefox(doc)) {\n    injectScriptletFirefox(s, doc);\n  } else {\n    injectScriptlet(s, doc);\n  }\n}\n"],"names":["SCRIPT_ID","IGNORED_TAGS","Set","isElement","node","nodeType","extractFeaturesFromDOM","roots","ignoredTags","classes","hrefs","ids","root","element","querySelectorAll","has","nodeName","toLowerCase","id","add","classList","cls","href","getAttribute","Array","from","autoRemoveScript","script","insertNode","document","parent","head","documentElement","appendChild","constructor","cb","this","knownIds","knownHrefs","knownClasses","observer","queryAll","window","type","elements","handleUpdatedNodes","start","undefined","MutationObserver","mutations","mutation","target","push","addedNode","addedNodes","getElementsFromMutations","observe","attributes","attributeFilter","childList","subtree","stop","disconnect","handleNewFeatures","newIds","newClasses","newHrefs","length","filter","e","s","doc","_c","_b","defaultView","_a","navigator","userAgent","indexOf","isFirefox","createElement","async","createTextNode","injectScriptlet","win","blob","Blob","url","URL","createObjectURL","src","revokeObjectURL","injectScriptletFirefox"],"mappings":"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"}